name: Deploy with Ansible (no magic)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
  RUN_MIGRATIONS: ${{ secrets.RUN_MIGRATIONS }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Write SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Create inventory
        run: |
          #EC2_IP_CLEAN="$(echo "${{ secrets.EC2_IP }}" | tr -d '[:space:]')"
          cat > inventory.ini <<EOF
          [edgepaas]
          3.227.242.107 ansible_user=ec2-user ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Debug inventory
        run: |
          cat -A inventory.ini

      - name: Run setup playbook
        run: |
          export ANSIBLE_ROLES_PATH="$GITHUB_WORKSPACE/ansible/roles"
          ansible-playbook -i inventory.ini ansible/playbooks/setup_docker.yml

      - name: Run deploy playbook
        run: |
          export ANSIBLE_ROLES_PATH="$GITHUB_WORKSPACE/ansible/roles"
          ansible-playbook -i inventory.ini ansible/playbooks/deploy_app.yml \
            --extra-vars "dockerhub_user=${{ secrets.DOCKER_USER }} app_name=edgeapp"

      - name: Cleanup
        run: |
          rm -f ~/.ssh/id_rsa inventory.ini
          echo "âœ… Deployment Successful"
