name: TESTER SCRIPT

on:
#  push: {}
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  APP_NAME: edgeapp
  APP_TAG: ${{ secrets.APP_TAG }}
  NO_CACHE: "true"
  EDGEPAAS_AWS_ROLE: ${{ secrets.EDGEPAAS_AWS_ROLE }}
  ALERT_EMAILS: ${{ secrets.ALERT_EMAILS }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------
      # AWS Auth (OIDC)
      # --------------------------------------------------
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ env.EDGEPAAS_AWS_ROLE }}
          aws-region: us-east-1

      # --------------------------------------------------
      # Email parsing
      # --------------------------------------------------
      - name: Prepare email variables
        run: |
          emails=${ALERT_EMAILS//[\[\]\"]}
          IFS=',' read -r EMAIL_FROM EMAIL_TO <<< "$emails"

          echo "EMAIL_FROM=$EMAIL_FROM" >> $GITHUB_ENV
          echo "EMAIL_TO=$EMAIL_TO" >> $GITHUB_ENV

          if [[ -z "$EMAIL_FROM" || -z "$EMAIL_TO" ]]; then
            echo "❌ Email variables are missing"
            exit 1
          fi

      # --------------------------------------------------
      # Docker login
      # --------------------------------------------------
      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # --------------------------------------------------
      # Build version (commit SHA)
      # --------------------------------------------------
      - name: Set BUILD_VERSION
        run: |
          echo "BUILD_VERSION=${GITHUB_SHA}" >> $GITHUB_ENV
          #echo "Using BUILD_VERSION=${GITHUB_SHA}"

      # --------------------------------------------------
      # Build & Push (NO CACHE)
      # --------------------------------------------------
      - name: Build & Push Docker images (no cache)
        if: env.NO_CACHE == 'true'
        run: |
          docker build --no-cache -t ${DOCKER_USER}/${APP_NAME}:${BUILD_VERSION}-blue ./docker
          docker build --no-cache -t ${DOCKER_USER}/${APP_NAME}:${BUILD_VERSION}-green ./docker

          docker push ${DOCKER_USER}/${APP_NAME}:${BUILD_VERSION}-blue
          docker push ${DOCKER_USER}/${APP_NAME}:${BUILD_VERSION}-green

      # --------------------------------------------------
      # Build & Push (CACHED)
      # --------------------------------------------------
      - name: Build & Push Docker images (cached)
        if: env.NO_CACHE != 'true'
        run: |
          docker build -t ${DOCKER_USER}/${APP_NAME}:latest-blue ./docker
          docker build -t ${DOCKER_USER}/${APP_NAME}:latest-green ./docker

          docker push ${DOCKER_USER}/${APP_NAME}:latest-blue
          docker push ${DOCKER_USER}/${APP_NAME}:latest-green

      # --------------------------------------------------
      # Fetch EC2 IP
      # --------------------------------------------------
      - name: Fetch EC2 public IP dynamically
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${APP_TAG}" \
            --query "Reservations[].Instances[] | [?State.Name=='running'].PublicIpAddress | [0]" \
            --output text)

          if [[ -z "$EC2_IP" || "$EC2_IP" == "null" ]]; then
            echo "❌ Could not determine EC2 IP"
            exit 1
          fi

          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
          echo "EC2 IP: $EC2_IP"

      # --------------------------------------------------
      # Install Ansible
      # --------------------------------------------------
      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible

      # --------------------------------------------------
      # SSH setup
      # --------------------------------------------------
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # --------------------------------------------------
      # Inventory
      # --------------------------------------------------
      - name: Create inventory
        run: |
          cat > test_dir/inventory.ini <<EOF
          [test]
          edgepaas ansible_host=${EC2_IP} ansible_user=ec2-user ansible_python_interpreter=/usr/bin/python3 ansible_ssh_args='-o StrictHostKeyChecking=no'
          EOF

          cat test_dir/inventory.ini

      # --------------------------------------------------
      # Run Ansible
      # --------------------------------------------------
      - name: Run Ansible
        working-directory: test_dir
        run: |
          ansible-playbook \
            -i inventory.ini \
            run.yml \
            --extra-vars "DOCKER_USER=${DOCKER_USER} APP_NAME=${APP_NAME} EC2_IP=${EC2_IP}"
        env:
          BUILD_VERSION: ${{ env.BUILD_VERSION }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          RUN_MIGRATIONS: ${{ secrets.RUN_MIGRATIONS }}
          USE_SQLITE: "false"
          BOTH_DB: "true"
          ANSIBLE_HOST_KEY_CHECKING: "false"
          EMAIL_FROM: ${{ env.EMAIL_FROM }}
          EMAIL_TO: ${{ env.EMAIL_TO }}
          EMAIL_PASS: ${{ secrets.ALERT_EMAIL_PASSWORD }}

      # --------------------------------------------------
      # Final
      # --------------------------------------------------
      - name: Final confirm
        run: echo "✅ Pipeline completed successfully"
