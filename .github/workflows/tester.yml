name: TESTER

on:
  push: {}
  workflow_dispatch:

permissions:
  id-token: write   # Required for OIDC
  contents: read

env:
  EDGEPAAS_AWS_ROLE: ${{ secrets.EDGEPAAS_AWS_ROLE }}
  APP_NAME: edgeapp
  GH_PAT: ${{ secrets.GH_PAT }}

jobs:
  fetch-and-test-ip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ env.EDGEPAAS_AWS_ROLE }}
          aws-region: us-east-1

      - name: Fetch EC2 IP dynamically
        id: fetch_ip
        run: |
          # Get the EC2 IP (example using 'Name' tag filter)
          RAW_EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=edgeapp-instance" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)

          echo "RAW_EC2_IP=$RAW_EC2_IP"

          # Add a temporary marker for testing
          MOD_IP="${RAW_EC2_IP}#"
          echo "MOD_IP=$MOD_IP" >> $GITHUB_ENV

          echo "===== STEP 1: Original and modified IP ====="
          echo "RAW_EC2_IP='$RAW_EC2_IP'"
          echo "MOD_IP='$MOD_IP'"

      - name: Rebuild and split IP safely
        run: |
          echo "===== STEP 2: Retrieve and Rebuild ====="

          # Retrieve from GitHub env
          MOD_IP_RAW="${MOD_IP//[$'\r\n']}"
          echo "MOD_IP_RAW='$MOD_IP_RAW'"

          # Remove marker and whitespace
          REBUILT_IP="${MOD_IP_RAW//#/}"
          REBUILT_IP="$(echo "$REBUILT_IP" | tr -d '[:space:]')"
          echo "REBUILT_IP='$REBUILT_IP'"

          # Split into octets safely
          IFS='.' read -r OCT1 OCT2 OCT3 OCT4 <<< "$REBUILT_IP"

          echo "Octet 1='$OCT1'"
          echo "Octet 2='$OCT2'"
          echo "Octet 3='$OCT3'"
          echo "Octet 4='$OCT4'"

          # Export full rebuilt IP for later steps
          echo "TARGET_HOST_IP=$REBUILT_IP" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add dynamic EC2 IP to known_hosts safely
          ssh-keyscan -H "$TARGET_HOST_IP" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Test Ansible / Echo IP
        run: |
          echo "Ready to use IP in Ansible: $TARGET_HOST_IP"
          echo "Octets: $OCT1 $OCT2 $OCT3 $OCT4"
