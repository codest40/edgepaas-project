name: Test EC2 IP Mutation

on:
  workflow_dispatch:


env:
  EC2_IP: ${{ secrets.EC2_IP }}

jobs:
  mutate-ip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Modify EC2 IP and send to GITHUB_ENV
        run: |
          RAW_EC2_IP="${{ secrets.EC2_IP }}"

          echo "===== STEP 1: Original EC2 IP ====="
          echo "RAW_EC2_IP='$RAW_EC2_IP'"

          # Insert marker '#' after 3rd octet
          MOD_IP="$(echo "$RAW_EC2_IP" | sed 's/^\(\([0-9]\+\.\)\{3\}\)/\1#/')"

          echo "MOD_IP after modification='$MOD_IP'"

          # Send to GitHub environment
          echo "MOD_IP=$MOD_IP" >> $GITHUB_ENV

      - name: Retrieve modified IP, rebuild and split
        run: |
          echo "===== STEP 2: Retrieve and Rebuild ====="

          # Retrieve from GitHub environment
          echo "MOD_IP from env='$MOD_IP'"

          # Remove marker
          REBUILT_IP="${MOD_IP//#/}"

          echo "REBUILT_IP after cleaning='$REBUILT_IP'"

          # Split into octets for verification
          IFS='.' read -r OCT1 OCT2 OCT3 OCT4 <<< "$REBUILT_IP"

          echo "Octet 1='$OCT1'"
          echo "Octet 2='$OCT2'"
          echo "Octet 3='$OCT3'"
          echo "Octet 4='$OCT4'"

      - name: use rebuilt IP for SSH test
        run: |
          echo "You can now use $REBUILT_IP for SSH or Ansible"
