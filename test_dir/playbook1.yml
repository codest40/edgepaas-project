---
- name: Pre-deployment connectivity and runtime smoke test
  hosts: test
  gather_facts: no

  vars:
    health_host: 127.0.0.1
    test_ports:
      - 8080
      - 8081

  tasks:
    # -------------------------------
    # Identify host & connection
    # -------------------------------
    - name: Identify remote host
      ansible.builtin.command: hostname
      register: host_out

    - name: Show execution context
      ansible.builtin.debug:
        msg:
          - "Running on host      → {{ host_out.stdout }}"
          - "Inventory hostname   → {{ inventory_hostname }}"
          - "Connection type      → {{ ansible_connection | default('ssh') }}"

    # -------------------------------
    # Port reachability checks
    # -------------------------------
    - name: Check application ports are reachable
      ansible.builtin.wait_for:
        host: "{{ health_host }}"
        port: "{{ item }}"
        timeout: 5
      loop: "{{ test_ports }}"
      ignore_errors: true

    # -------------------------------
    # HTTP checks
    # -------------------------------
    - name: Perform HTTP checks on application ports
      ansible.builtin.uri:
        url: "http://{{ health_host }}:{{ item }}"
        method: GET
        status_code: 200
        timeout: 5
      loop: "{{ test_ports }}"
      ignore_errors: true

    # -------------------------------
    # Raw fallback connectivity test
    # -------------------------------
    - name: Raw curl fallback test (port 80)
      ansible.builtin.command: curl -v http://{{ health_host }}:80
      ignore_errors: true
