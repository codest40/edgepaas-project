---
# Install Docker and prepare host for containers
# Install Docker on Amazon Linux 2023 (cgroup v2 compatible)

- name: Ensure required packages are installed
  ansible.builtin.yum:
    name:
      - dnf
      - dnf-plugins-core
      - git
      - xfsprogs
      - yum-utils
    state: present
  become: true

- name: Remove Any old conflicting Docker packages (EL7/CentOS)
  ansible.builtin.yum:
    name:
      - docker-ce
      - docker-ce-cli
      - docker-engine
      - docker.io
    state: absent
  become: true
  ignore_errors: true

- name: Clean dnf/yum cache
  ansible.builtin.command: dnf clean all
  become: true

- name: Install Docker (AL2023 default package)
  ansible.builtin.yum:
    name: docker
    state: present
  become: true

- name: Configure Docker for systemd cgroup driver
  ansible.builtin.copy:
    dest: /etc/docker/daemon.json
    content: |
      {
        "exec-opts": ["native.cgroupdriver=systemd"]
      }
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Ensure Docker service is enabled and running
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true

- name: Add current user to docker group
  become: true
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

- name: Verify Docker installation
  ansible.builtin.shell: docker info
  register: docker_info
  changed_when: false
  failed_when: "'Cgroup' not in docker_info.stdout"
  become: true
