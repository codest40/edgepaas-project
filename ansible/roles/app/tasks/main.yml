---
# Deploy EdgePaaS app (blue-green) dynamically with Docker

- name: Deployment Notice!!!
  debug:
    msg: "EdgePaaS uses self-managed blue/green deployment. Color flags are ignored."

- name: First, Ensure required environment variables Are Detectable
  vars:
    required_vars:
      - DATABASE_URL
      - RUN_MIGRATIONS
      - OPENWEATHER_API_KEY
  block:
    - name: Ensure required vars are defined
      ansible.builtin.assert:
        that:
          - hostvars[inventory_hostname][item] is defined
          - hostvars[inventory_hostname][item] | length > 0
        fail_msg: "Required var '{{ item }}' is missing or empty!"
        success_msg: "Var '{{ item }}' detected with value."
      loop: "{{ required_vars }}"

- name: Debug active container ports
  ansible.builtin.debug:
    msg:
      - "Active host port: {{ active_port }}"
      - "Inactive host port: {{ inactive_port }}"
      - "Container default port: {{ container_port | default(80) }}"
      - "Docker port mapping for active container will be: {{ active_port }}:{{ container_port | default(80) }}"
      - "Docker port mapping for inactive container will be: {{ inactive_port }}:{{ container_port | default(80) }}"

- name: Create directories for app
  ansible.builtin.file:
    path: /opt/edgepaas/app
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Ensure dockerhub_user is defined
  assert:
    that:
      - dockerhub_user is defined
      - dockerhub_user | length > 0
    fail_msg: "dockerhub_user is empty — Docker images cannot be pulled"

- name: Copy docker disk setup script
  copy:
    src: files/setup_docker_disk.sh
    dest: /usr/local/bin/setup_docker_disk.sh
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Run docker disk setup script
  command: /usr/local/bin/setup_docker_disk.sh
  become: true
  register: docker_disk_result
  changed_when: "'already configured' not in docker_disk_result.stdout"

- name: Wait And Ensure docker mount exists
  ansible.builtin.wait_for:
    path: /var/lib/docker
    state: present
    timeout: 60

- name: Restart docker after mount
  ansible.builtin.service:
    name: docker
    state: restarted

# ----------------------------
# Pull Docker images
# ----------------------------
- name: Pull Docker images for blue and green from Docker Hub
  ansible.builtin.docker_image:
    name: "{{ dockerhub_user }}/{{ app_name }}:latest-{{ item }}"
    source: pull
  loop:
    - blue
    - green


- name: Load active color if exists
  slurp:
    src: /opt/edgepaas/ACTIVE_COLOR
  register: active_color_file
  ignore_errors: yes

- name: Set active_color from persisted state
  set_fact:
    active_color: "{{ active_color_file.content | b64decode }}"
  when: active_color_file is succeeded

- name: Warn if color vars are passed manually
  ansible.builtin.debug:
    msg: >
      Do NOT include blue/green color vars.
      Deployment color is automatically managed.
      Passed values are ignored.
  when:
    - active_color_file is succeeded
    - active_color is defined


- name: Derive inactive color from active color
  ansible.builtin.set_fact:
    inactive_color: "{{ 'green' if active_color == 'blue' else 'blue' }}"
  when: active_color is defined

# ----------------------------
# Debug before swapping
# ----------------------------
- name: Show current active/inactive containers
  ansible.builtin.debug:
    msg:
      - "Before Swap:"
      - "Active container → {{ active_color }} : host port {{ active_port }}"
      - "Inactive container → {{ inactive_color }} : host port {{ inactive_port }}"


# ----------------------------
# Start new container on inactive_port
# ----------------------------
- name: Start new container on inactive_port
  ansible.builtin.docker_container:
    name: "{{ app_name }}-{{ inactive_color }}"
    image: "{{ dockerhub_user }}/{{ app_name }}:latest-{{ inactive_color }}"
    state: started
    restart_policy: always
    ports:
      - "{{ inactive_port }}:{{ container_port | default(80) }}"
    env:
      DATABASE_URL: "{{ lookup('env','DATABASE_URL') }}"
      CONTAINER_PORT: "{{ container_port | default(80) }}"
      RUN_MIGRATIONS: "true"

# ----------------------------
# Wait for new container health
# ----------------------------
- name: Wait for new container health endpoint
  uri:
    url: "http://127.0.0.1:{{ inactive_port }}/health"
    method: GET
    status_code: 200
    return_content: no
    timeout: 5
  register: health_check_new
  retries: 10
  delay: 5
  until: health_check_new is succeeded or (health_check_new.status is defined and health_check_new.status == 200)

# ----------------------------
# Switch Nginx to new active container
# ----------------------------
- name: Update Nginx active backend to new container
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/conf.d/edgepaas.conf
    owner: root
    group: root
    mode: '0644'
    force: yes
  vars:
    active_port: "{{ inactive_port }}"
    inactive_port: "{{ active_port }}"
    active_color: "{{ inactive_color }}"
    inactive_color: "{{ active_color }}"
  become: true
  notify: Reload nginx

- name: Freeze swap state (facts)
  ansible.builtin.set_fact:
    new_active_color: "{{ inactive_color }}"
    new_active_port: "{{ inactive_port }}"
    old_active_color: "{{ active_color }}"
    old_active_port: "{{ active_port }}"

- name: Persist active color
  copy:
    content: "{{ new_active_color }}"
    dest: /opt/edgepaas/ACTIVE_COLOR

# ----------------------------
# Debug after Nginx swap
# ----------------------------
- name: Show active/inactive after swap
  ansible.builtin.debug:
    msg:
      - "After swap:"
      - "New ACTIVE → {{ new_active_color }} on port {{ new_active_port }}"
      - "Old ACTIVE (rollback candidate) → {{ old_active_color }} on port {{ old_active_port }}"

# ----------------------------
# Test nginx config
# ----------------------------
- name: Test nginx configuration
  ansible.builtin.command: nginx -t
  become: true
  register: nginx_test

# ----------------------------
# Ensure nginx is running
# ----------------------------
- name: Ensure nginx is started
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true
  become: true

# ----------------------------
# Stop previous active container
# ----------------------------
- name: Wait before removing old container (rollback window)
  ansible.builtin.pause:
    minutes: 2

- name: then We Stop old container
  ansible.builtin.docker_container:
    name: "{{ app_name }}-{{ old_active_color }}"
    state: absent
    force_kill: yes
