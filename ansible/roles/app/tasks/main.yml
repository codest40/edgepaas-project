---
# Deploy EdgePaaS app (blue-green) dynamically with Docker

- name: Deployment Notice!!!
  ansible.builtin.debug:
    msg: >
      EdgePaaS uses self-managed blue/green deployment.
      Active color is derived from persisted state.
      Do not pass color vars manually.

#------------------------------
# Detect CICD OR Local
#------------------------------
- name: Detect if running in CI/CD
  ansible.builtin.set_fact:
    is_cicd: "{{ lookup('env','GITHUB_ACTIONS') | default(false) | bool }}"

- name: Who Is host?
  command: hostname
  register: result

- name: Show Hostname
  ansible.builtin.debug:
    msg: "Hostname: {{ result.stdout_lines }}"

- name: Debug CI/CD detection
  ansible.builtin.debug:
    msg: "Running in CI/CD? {{ is_cicd }}"

- name: Debug ansible_host
  ansible.builtin.debug:
    msg: "Connecting to {{ ansible_host }}"

- name: Set health check host
  ansible.builtin.set_fact:
    health_host: "{{ 'localhost' if not is_cicd else '127.0.0.1' }}"

# --------------------------------------------------
# Validate required env vars
# --------------------------------------------------
- name: Ensure required environment variables are detectable
  vars:
    required_vars:
      - DATABASE_URL
      - RUN_MIGRATIONS
      - OPENWEATHER_API_KEY
  block:
    - name: Ensure required vars are defined
      ansible.builtin.assert:
        that:
          - lookup('env', item) | length > 0
        fail_msg: "Required env var '{{ item }}' is missing or empty!"
        success_msg: "Env var '{{ item }}' detected."
      loop: "{{ required_vars }}"

# ---------------------------------------
# Capture supplied ports (environment)
# ---------------------------------------
- name: Capture supplied host ports from environment
  ansible.builtin.set_fact:
    supplied_active_port: "{{ lookup('env', 'ACTIVE_HOST_PORT') | default('0') }}"
    supplied_inactive_port: "{{ lookup('env', 'INACTIVE_HOST_PORT') | default('0') }}"

# ---------------------------------------
# Resolve final ports (bootstrap defaults if 0 or empty)
# ---------------------------------------
- name: Resolve final ports
  ansible.builtin.set_fact:
    resolved_active_port: "{{ (supplied_active_port | int) if (supplied_active_port | int) > 0 else 8080 }}"
    resolved_inactive_port: "{{ (supplied_inactive_port | int) if (supplied_inactive_port | int) > 0 else 8081 }}"

# ---------------------------------------
# Inform if default ports are used
# ---------------------------------------
- name: Inform if default ports are used
  ansible.builtin.debug:
    msg: "Complete host ports NOT supplied, using defaults: ACTIVE={{ resolved_active_port }}, INACTIVE={{ resolved_inactive_port }}"
  when: supplied_active_port | int == 0 or supplied_inactive_port | int == 0

# ---------------------------------------
# Validate resolved host ports (force int using ternary)
# ---------------------------------------
- name: Validate resolved host ports
  ansible.builtin.assert:
    that:
      - (resolved_active_port | int) != (resolved_inactive_port | int)
      - (resolved_active_port | int) > 0
      - (resolved_inactive_port | int) > 0
      - (resolved_active_port | int) < 65536
      - (resolved_inactive_port | int) < 65536
    fail_msg: >
      Invalid host port configuration.
      ACTIVE={{ resolved_active_port }},
      INACTIVE={{ resolved_inactive_port }}


- name: Show final host ports to be used
  ansible.builtin.debug:
    msg:
      - "Stable ACTIVE host port   → {{ resolved_active_port }}"
      - "Stable INACTIVE host port → {{ resolved_inactive_port }}"

# --------------------------------------------------
# Docker filesystem setup
# --------------------------------------------------
- name: Create directories for app
  ansible.builtin.file:
    path: /opt/edgepaas/app
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Ensure dockerhub_user is defined
  ansible.builtin.assert:
    that:
      - dockerhub_user is defined
      - dockerhub_user | length > 0
    fail_msg: "dockerhub_user is empty — Docker images cannot be pulled"

- name: Copy docker disk setup script
  ansible.builtin.copy:
    src: files/setup_docker_disk.sh
    dest: /usr/local/bin/setup_docker_disk.sh
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Run docker disk setup script
  ansible.builtin.command: /usr/local/bin/setup_docker_disk.sh
  become: true
  register: docker_disk_result
  changed_when: "'already configured' not in docker_disk_result.stdout"

- name: Ensure docker mount exists
  ansible.builtin.wait_for:
    path: /var/lib/docker
    state: present
    timeout: 60

- name: Restart docker
  ansible.builtin.service:
    name: docker
    state: restarted
  become: true

# --------------------------------------------------
# Pull images
# --------------------------------------------------
- name: Pull Docker images
  ansible.builtin.docker_image:
    name: "{{ dockerhub_user }}/{{ app_name }}:latest-{{ item }}"
    source: pull
  loop:
    - blue
    - green

# --------------------------------------------------
# Load persisted active color
# --------------------------------------------------
- name: Load active color if exists
  ansible.builtin.slurp:
    src: /opt/edgepaas/ACTIVE_COLOR
  register: active_color_file
  ignore_errors: true

- name: Bootstrap active_color on first deployment
  ansible.builtin.set_fact:
    active_color: blue
  when: active_color_file is failed

- name: Set active_color from persisted state
  ansible.builtin.set_fact:
    active_color: "{{ active_color_file.content | b64decode }}"
  when: active_color_file is succeeded

- name: Derive inactive color
  ansible.builtin.set_fact:
    inactive_color: "{{ 'green' if active_color == 'blue' else 'blue' }}"

# --------------------------------------------------
# Derive current nginx ports (state-only)
# --------------------------------------------------
- name: Derive nginx ports from active color
  ansible.builtin.set_fact:
    nginx_active_port: "{{ resolved_active_port if active_color == 'blue' else resolved_inactive_port }}"
    nginx_inactive_port: "{{ resolved_inactive_port if active_color == 'blue' else resolved_active_port }}"

- name: Show current host ports before Swap
  ansible.builtin.debug:
    msg:
      - "Current ACTIVE   → {{ active_color }} on {{ nginx_active_port }}"
      - "Current INACTIVE → {{ inactive_color }} on {{ nginx_inactive_port }}"

# --------------------------------------------------
# Deploy new version to inactive slot
# --------------------------------------------------
- name: Start new container on inactive slot
  ansible.builtin.docker_container:
    name: "{{ app_name }}-{{ inactive_color }}"
    image: "{{ dockerhub_user }}/{{ app_name }}:latest-{{ inactive_color }}"
    state: started
    restart_policy: always
    ports:
      - "{{ nginx_inactive_port }}:{{ container_port | default(80) }}"
    env:
      DATABASE_URL: "{{ lookup('env','DATABASE_URL') }}"
      CONTAINER_PORT: "{{ container_port | default(80) | string }}"
      RUN_MIGRATIONS: "true"
    env_file: /opt/edgepaas/.env.test

- name: Wait for inactive port to be open
  wait_for:
    host: "{{ health_host }}"
    port: "{{ nginx_inactive_port }}"
    timeout: 10
    state: started

- name: Test HTTP connectivity to Google
  ansible.builtin.uri:
    url: https://www.google.com
    method: GET
    status_code: 200
    timeout: 5
  delegate_to: localhost
  register: google_check
  retries: 3
  delay: 2
  until: google_check.status == 200
  when: is_cicd

- name: Debug connectivity result
  ansible.builtin.debug:
    var: google_check.status
  when: is_cicd


- name: Wait for new container to Respond
  ansible.builtin.uri:
    url: "http://{{ health_host }}:{{ nginx_inactive_port }}/health"
    method: GET
    status_code: 200
    timeout: 5
  register: health_check_new
  retries: 5
  delay: 5
  until: health_check_new is succeeded
  delegate_to: "{{ inventory_hostname if is_cicd else omit }}"

- name: Ensure app confirmed it is healthy
  assert:
    that:
      - health_check_new.status == 200
  delegate_to: "{{ inventory_hostname if is_cicd else omit }}"

# --------------------------------------------------
# Define swap intent
# --------------------------------------------------
- name: Define nginx swap intent
  ansible.builtin.set_fact:
    next_active_color: "{{ inactive_color }}"
    next_active_port: "{{ nginx_inactive_port }}"
    rollback_color: "{{ active_color }}"
    rollback_port: "{{ nginx_active_port }}"

- name: DEBUG nginx switch intent result
  ansible.builtin.debug:
    msg:
      - "Switching nginx to:"
      - "NEW ACTIVE → {{ next_active_color }} on {{ next_active_port }}"
      - "ROLLBACK   → {{ rollback_color }} on {{ rollback_port }}"

# --------------------------------------------------
# Switch nginx
# --------------------------------------------------
- name: Update nginx to new active container
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/conf.d/edgepaas.conf
    owner: root
    group: root
    mode: '0644'
    force: true
  vars:
    active_port: "{{ next_active_port }}"
    inactive_port: "{{ rollback_port }}"
  become: true
  notify: Reload nginx

# --------------------------------------------------
# Freeze swap state
# --------------------------------------------------
- name: Freeze swap state
  ansible.builtin.set_fact:
    new_active_color: "{{ next_active_color }}"
    new_active_port: "{{ next_active_port }}"
    old_active_color: "{{ rollback_color }}"
    old_active_port: "{{ rollback_port }}"

# --------------------------------------------------
# Persist active color
# --------------------------------------------------
- name: Persist active color
  ansible.builtin.copy:
    content: "{{ new_active_color }}"
    dest: /opt/edgepaas/ACTIVE_COLOR

- name: Show final state
  ansible.builtin.debug:
    msg:
      - "ACTIVE   → {{ new_active_color }} on {{ new_active_port }}"
      - "OLD      → {{ old_active_color }} on {{ old_active_port }}"

# --------------------------------------------------
# Validate nginx
# --------------------------------------------------
- name: Test nginx config
  ansible.builtin.command: nginx -t
  become: true

- name: Ensure nginx is running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true
  become: true

# --------------------------------------------------
# Rollback window then cleanup
# --------------------------------------------------
- name: Rollback window
  ansible.builtin.pause:
    minutes: 1

- name: Stop old container
  ansible.builtin.docker_container:
    name: "{{ app_name }}-{{ old_active_color }}"
    state: absent
    force_kill: true
