---
# Deploy EdgePaaS app (blue-green) dynamically with Docker

- name: First, Ensure required environment variables Are Detectable
  vars:
    required_vars:
      - DATABASE_URL
      - RUN_MIGRATIONS
      - OPENWEATHER_API_KEY
  block:
    - name: Ensure required vars are defined
      ansible.builtin.assert:
        that:
          - hostvars[inventory_hostname][item] is defined
          - hostvars[inventory_hostname][item] | length > 0
        fail_msg: "Required var '{{ item }}' is missing or empty!"
        success_msg: "Var '{{ item }}' detected with value."
      loop: "{{ required_vars }}"


- name: Create directories for app
  ansible.builtin.file:
    path: /opt/edgepaas/app
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Ensure dockerhub_user is defined
  assert:
    that:
      - dockerhub_user is defined
      - dockerhub_user | length > 0
    fail_msg: "dockerhub_user is empty â€” Docker images cannot be pulled"

- name: Copy docker disk setup script
  copy:
    src: files/setup_docker_disk.sh
    dest: /usr/local/bin/setup_docker_disk.sh
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Run docker disk setup script
  command: /usr/local/bin/setup_docker_disk.sh
  become: true
  register: docker_disk_result
  changed_when: "'already configured' not in docker_disk_result.stdout"

- name: Wait And Ensure docker mount exists
  ansible.builtin.wait_for:
    path: /var/lib/docker
    state: present
    timeout: 60

- name: Restart docker after mount
  ansible.builtin.service:
    name: docker
    state: restarted

# ----------------------------
# Pull Docker images
# ----------------------------
- name: Pull Docker images for blue and green from Docker Hub
  ansible.builtin.docker_image:
    name: "{{ dockerhub_user }}/{{ app_name }}:latest-{{ item }}"
    source: pull
  loop:
    - blue
    - green

# ----------------------------
# Start new active container
# ----------------------------
- name: Start active container
  ansible.builtin.docker_container:
    name: "{{ app_name }}-{{ active_color }}"
    image: "{{ dockerhub_user }}/{{ app_name }}:latest-{{ active_color }}"
    state: started
    restart_policy: always
    ports:
      - "{{ active_port }}:{{ container_port | default(8080) }}"
    env:
      DATABASE_URL: "{{ lookup('env','DATABASE_URL') }}"
      CONTAINER_PORT: "{{ container_port | default(8080) }}"
      RUN_MIGRATIONS: "true"

# ----------------------------
# Wait for active container to become healthy
# ----------------------------
- name: Wait for active container health endpoint
  uri:
    url: "http://127.0.0.1:{{ active_port }}/health"
    method: GET
    status_code: 200
    return_content: no
    timeout: 5
  register: health_check
  retries: 10
  delay: 5
  until: health_check is succeeded and health_check.status_code == 200

# ----------------------------
# Configure Nginx for blue-green routing
# ----------------------------
- name: Configure Nginx
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/conf.d/edgepaas.conf
    owner: root
    group: root
    mode: '0644'
    force: yes
  become: true
  notify: Reload nginx

# ----------------------------
# Test nginx config
# ----------------------------
- name: Test nginx configuration
  ansible.builtin.command: nginx -t
  become: true
  register: nginx_test

# ----------------------------
# Ensure nginx is running
# ----------------------------
- name: Ensure nginx is started
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true
  become: true

# ----------------------------
# Stop previous active container (optional, keeps one old for rollback)
# ----------------------------
- name: Wait before removing old container (rollback window)
  ansible.builtin.pause:
    minutes: 2

- name: Stop old inactive container if any
  ansible.builtin.docker_container:
    name: "{{ app_name }}-{{ inactive_color }}"
    state: absent
    force_kill: yes
