---
# =============================================================================
# EdgePaaS Post-Deployment Checks, Alerts, and Old Container Cleanup
# =============================================================================

- name: FINAL CHECKS
  ansible.builtin.debug:
    msg: "FINAL CHECKS SECTION"

# -----------------------------
# Port Reachability Checks
# -----------------------------
- name: Check if ACTIVE_COLOR exists and is non-empty
  ansible.builtin.stat:
    path: /opt/edgepaas/ACTIVE_COLOR
  register: active_color_stat

- name: Wait for application ports to be reachable
  ansible.builtin.wait_for:
    host: "{{ health_host }}"
    port: "{{ item }}"
    timeout: 5
  loop: >-
    {{
      [nginx_inactive_port]
      + ([nginx_active_port] if active_color_stat.stat.exists and active_color_stat.stat.size > 0 else [])
    }}
  loop_control:
    label: "Port {{ item }}"
  register: port_results
  ignore_errors: true

- name: Log port check results
  ansible.builtin.debug:
    msg: >-
      {% if item.failed %}
        [EDGEPAAS_HEALTHCHECK_FAILED] Port {{ item.item }} unreachable on {{ health_host }}
      {% else %}
        [EDGEPAAS_HEALTHCHECK_OK] Port {{ item.item }} reachable on {{ health_host }}
      {% endif %}
  loop: "{{ port_results.results }}"

# -----------------------------
# HTTP Checks
# -----------------------------
- name: HTTP GET checks on application ports
  ansible.builtin.uri:
    url: "http://{{ health_host }}:{{ item }}"
    method: GET
    status_code: 200
    timeout: 5
  loop: >-
    {{
       [nginx_inactive_port]
       + ([nginx_active_port] if active_color_stat.stat.exists and active_color_stat.stat.size > 0 else [])
    }}
  loop_control:
    label: "HTTP check on port {{ item }}"
  register: http_results
  ignore_errors: true

- name: Log HTTP check results
  ansible.builtin.debug:
    msg: >-
      {% if item.failed %}
        [EDGEPAAS_HEALTHCHECK_FAILED] HTTP endpoint http://{{ health_host }}:{{ item.item }} failed
      {% else %}
        [EDGEPAAS_HEALTHCHECK_OK] HTTP endpoint http://{{ health_host }}:{{ item.item }} OK
      {% endif %}
  loop: "{{ http_results.results }}"

# -----------------------------
# Application Health Endpoints
# -----------------------------
- name: Check /health endpoint
  ansible.builtin.uri:
    url: "http://{{ health_host }}:{{ nginx_inactive_port }}/health"
    method: GET
    status_code: 200
    timeout: 5
  register: health_endpoint
  ignore_errors: true

- name: Check /health/ready endpoint
  ansible.builtin.uri:
    url: "http://{{ health_host }}:{{ nginx_inactive_port }}/health/ready"
    method: GET
    status_code: 200
    timeout: 5
  register: health_ready
  ignore_errors: true

- name: Check /health/system endpoint
  ansible.builtin.uri:
    url: "http://{{ health_host }}:{{ nginx_inactive_port }}/health/system"
    method: GET
    status_code: 200
    timeout: 5
  register: health_system
  ignore_errors: true

- name: Check /health/live endpoint
  ansible.builtin.uri:
    url: "http://{{ health_host }}:{{ nginx_inactive_port }}/health/live"
    method: GET
    status_code: 200
    timeout: 5
  register: health_live
  ignore_errors: true

- name: Log all health endpoint results
  ansible.builtin.debug:
    msg:
      - "/health        → {{ 'OK' if not health_endpoint.failed else 'FAILED' }}"
      - "/health/ready  → {{ 'OK' if not health_ready.failed else 'FAILED' }}"
      - "/health/system → {{ 'OK' if not health_system.failed else 'FAILED' }}"
      - "/health/live   → {{ 'OK' if not health_live.failed else 'FAILED' }}"

# -----------------------------
# Aggregate FINAL Health Result
# -----------------------------
- name: Determine final healthcheck result
  ansible.builtin.set_fact:
    final_healthcheck_failed: >-
      {{
        (port_results.results | selectattr('failed', 'equalto', true) | list | length > 0)
        or (http_results.results | selectattr('failed', 'equalto', true) | list | length > 0)
        or health_endpoint.failed
        or health_ready.failed
        or health_system.failed
        or health_live.failed
      }}

# -----------------------------
# FINAL FAILURE ALERT (CRITICAL)
# -----------------------------
- name: Send FINAL healthcheck failure email
  mail:
    host: smtp.gmail.com
    port: 587
    username: "{{ EMAIL_FROM }}"
    password: "{{ EMAIL_PASS }}"
    to: "{{ EMAIL_TO }}"
    subject: "❌ Final Healthcheck Failed"
    body: |
      Final healthcheck FAILED at {{ ansible_date_time.iso8601 }}.

      Host: {{ health_host }}
      App: {{ APP_NAME }}

      One or more ports or health endpoints are unhealthy.
      Immediate attention required.
  when: final_healthcheck_failed

# -----------------------------
# HARD FAIL AFTER ALERT
# -----------------------------
- name: Fail if final healthcheck failed
  ansible.builtin.fail:
    msg: "❌ Final healthcheck failed — deployment aborted."
  when: final_healthcheck_failed

# -----------------------------
# FINAL SUCCESS ALERT
# -----------------------------
- name: Send FINAL success email
  mail:
    host: smtp.gmail.com
    port: 587
    username: "{{ EMAIL_FROM }}"
    password: "{{ EMAIL_PASS }}"
    to: "{{ EMAIL_TO }}"
    subject: "✅ Final Healthcheck Passed"
    body: |
      Deployment completed successfully at {{ ansible_date_time.iso8601 }}.

      All ports and health endpoints passed:
      - /health
      - /health/ready
      - /health/system
      - /health/live
  when: not final_healthcheck_failed

# -----------------------------
# Shutdown Old Container (ONLY AFTER SUCCESS)
# -----------------------------
- name: Update color file for next Deploy
  ansible.builtin.copy:
    content: "{{ new_active_color }}"
    dest: /opt/edgepaas/ACTIVE_COLOR

- name: Stop old container after successful final checks
  ansible.builtin.docker_container:
    name: "{{ APP_NAME }}-{{ old_active_color }}"
    state: absent
    force_kill: true
  when: not final_healthcheck_failed

# -----------------------------
# Summary
# -----------------------------
- name: Health check completed
  ansible.builtin.debug:
    msg: "✅ Final healthcheck completed and old container cleaned up on {{ inventory_hostname }} at {{ ansible_date_time.iso8601 }} "

