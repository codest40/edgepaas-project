---
# =============================================================================
# EdgePaaS EC2 Preparation & Environment Setup Tasks
# =============================================================================

# -----------------------------
# Outline Info About Pipeline
# ----------------------------
- name: Deployment Notice
  ansible.builtin.debug:
    msg: >
      EdgePaaS uses self-managed blue/green deployment.
      Active color is derived from within.
      Do not pass color vars manually.

# -----------------------------
# Environment Variable Checks
# -----------------------------

- name: Define schema version
  ansible.builtin.set_fact:
    ENV_SCHEMA_VERSION: "1.0.0"

- name: Enforce schema version consistency
  ansible.builtin.assert:
    that:
      - ENV_SCHEMA_VERSION == "1.0.0"
    fail_msg: >
      ❌ ENV schema version mismatch.
      Expected 1.0.0 but got {{ ENV_SCHEMA_VERSION }}.
    success_msg: "✅ ENV schema version validated."

# -------------------------------------------------
# Define variable schema
# -------------------------------------------------

- name: Define required variables with strict types
  ansible.builtin.set_fact:
    required_vars_schema:
      BUILD_VERSION: string
      DOCKER_USER: string
      APP_NAME: string
      EC2_IP: string
      DATABASE_URL: url
      OPENWEATHER_API_KEY: string
      RUN_MIGRATIONS: boolean
      USE_SQLITE: boolean
      BOTH_DB: boolean
      ANSIBLE_HOST_KEY_CHECKING: boolean
      EMAIL_FROM: email
      EMAIL_TO: email
      EMAIL_PASS: secret

# -------------------------------------------------
# Ensure variables exist
# -------------------------------------------------

- name: Ensure required variables exist (env or extra-vars)
  ansible.builtin.assert:
    that:
      - >
        (
          hostvars[inventory_hostname].get(item.key)
          | default('', true)
          | string
        ) != ''
        or
        (
          lookup('env', item.key)
          | default('', true)
          | string
        ) != ''
    fail_msg: "❌ Required variable '{{ item.key }}' is missing or empty!"
    success_msg: "✅ Variable '{{ item.key }}' detected."
  loop: "{{ required_vars_schema | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

# -------------------------------------------------
# Promote variables
# -------------------------------------------------

- name: Promote all required variables to host facts
  ansible.builtin.set_fact:
    "{{ item.key }}": >-
      {{
        hostvars[inventory_hostname].get(item.key)
        | default(lookup('env', item.key), true)
      }}
  loop: "{{ required_vars_schema | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

# -------------------------------------------------
# STRICT TYPE VALIDATION
# -------------------------------------------------

- name: Validate strict types and formats
  ansible.builtin.assert:
    that:
      - >
        (
          item.value == 'string'
          and (vars[item.key] is string)
        )
        or
        (
          item.value == 'integer'
          and (vars[item.key] | string is match('^[0-9]+$'))
        )
        or
        (
          item.value == 'boolean'
          and (vars[item.key] | string | lower) in ['true','false']
        )
        or
        (
          item.value == 'url'
          and (vars[item.key] | string is match('^(postgresql|mysql|sqlite)://'))
        )
        or
        (
          item.value == 'email'
          and (vars[item.key] | string is match('^[^@]+@[^@]+\.[^@]+$'))
        )
        or
        (
          item.value == 'secret'
          and (vars[item.key] | string | length > 0)
        )
    fail_msg: >
      ❌ Variable '{{ item.key }}' failed validation.
      Expected type '{{ item.value }}'
      but got value '{{ vars[item.key] }}'
    success_msg: "✅ '{{ item.key }}' passed strict validation."
  loop: "{{ required_vars_schema | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

# -------------------------------------------------
# Normalize booleans and integers
# -------------------------------------------------

- name: Normalize boolean values
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ vars[item.key] | bool }}"
  when: item.value == 'boolean'
  loop: "{{ required_vars_schema | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Normalize integer values
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ vars[item.key] | int }}"
  when: item.value == 'integer'
  loop: "{{ required_vars_schema | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

# -------------------------------------------------
# Debug Output, Maske secrets
# -------------------------------------------------
#- name: Display validated vars
#  ansible.builtin.debug:
#    msg: >-
#      {{
#        dict(required_vars_schema.keys()
#        | zip(required_vars_schema.keys()
#        | map('extract', vars)))
#        | combine({
#            'EMAIL_PASS': '********'
#          })
#      }}

- name: Final validation confirmation
  ansible.builtin.debug:
    msg: >
      All environment variables passed schema validation.
      Deployment is deterministic and safe.


# -----------------------------
# Host Identification
# -----------------------------

- name: Identify remote host
  ansible.builtin.command:
    cmd: hostname
  register: host_out

- name: Show execution context
  ansible.builtin.debug:
    msg:
      - "Running on host      → {{ host_out.stdout }}"
      - "Inventory hostname   → {{ inventory_hostname }}"
      - "Connection type      → {{ ansible_connection | default('ssh') }}"

# -----------------------------
# CI/CD Detection and Host Setup
# -----------------------------

- name: Detect if running in CI/CD
  ansible.builtin.set_fact:
    is_cicd: "{{ lookup('env','GITHUB_ACTIONS') | default(false) | bool }}"

- name: Debug CI/CD detection
  ansible.builtin.debug:
    msg: "Running in CI/CD? {{ is_cicd }}"

- name: Set ansible_host explicitly for CI/CD
  ansible.builtin.set_fact:
    ansible_host: "{{ lookup('env', 'EC2_IP') }}"
  when: is_cicd

- name: Debug ansible_host
  ansible.builtin.debug:
    msg: "Connecting to Ansible_host: {{ ansible_host }}"

- name: Set health host
  ansible.builtin.set_fact:
    health_host: "127.0.0.1"

# -----------------------------
# Basic OS Preparation
# -----------------------------

- name: Get Host IP
  ansible.builtin.set_fact:
    private_ip: "{{ ansible_facts['default_ipv4']['address'] }}"

- name: Debug private IP
  debug:
    var: ansible_facts['default_ipv4']['address']

- name: Update package metadata only (safe for AL2023)
  ansible.builtin.yum:
    update_cache: true

- name: Ensure deploy user exists
  ansible.builtin.user:
    name: deploy
    comment: "EdgePaaS deploy user"
    shell: /bin/bash
    state: present
    create_home: yes

- name: Allow deploy user passwordless sudo
  ansible.builtin.copy:
    dest: /etc/sudoers.d/deploy
    content: "deploy ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: '0440'
  become: yes
  become_user: root

# -----------------------------
# Nginx Installation & Setup
# -----------------------------

- name: Install Nginx
  ansible.builtin.yum:
    name: nginx
    state: present

- name: Ensure nginx conf.d directory exists
  ansible.builtin.file:
    path: /etc/nginx/conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Remove default nginx site
  ansible.builtin.file:
    path: /etc/nginx/conf.d/default.conf
    state: absent

# -----------------------------
# Logging Directory
# -----------------------------

- name: Ensure log directory exists
  ansible.builtin.file:
    path: /var/log/edgepaas
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'

# -----------------------------
# Database Client Setup (PostgreSQL + SQLite fallback)
# -----------------------------

- name: Install PostgreSQL client (no server) and SSL deps
  become: true
  ansible.builtin.yum:
    name:
      - postgresql15
      - openssl
      - ca-certificates
    state: present

- name: Install Python DB libraries (no libpq-devel)
  become: true
  ansible.builtin.yum:
    name:
      - python3-psycopg2
      - sqlite
    state: present

# -----------------------------
# Environment Configuration (.env)
# -----------------------------
- name: Create EdgePaaS directory
  ansible.builtin.file:
    path: /opt/edgepaas
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'
  become: true

- name: Write DB environment file
  ansible.builtin.copy:
    dest: /opt/edgepaas/.env.test
    owner: ec2-user
    group: ec2-user
    mode: '0644'
    content: |
      DATABASE_URL={{ DATABASE_URL }}
      OPENWEATHER_API_KEY={{ OPENWEATHER_API_KEY }}
      DATABASE_URL_SQLITE=sqlite:////tmp/edgepaas/fallback.db

- name: Create directories for app
  ansible.builtin.file:
    path: /opt/edgepaas/app
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'


- name: DB client setup complete Msg
  ansible.builtin.debug:
    msg: >
      PostgreSQL client installed.
      SQLite fallback ready.
      No local PostgreSQL server installed.

