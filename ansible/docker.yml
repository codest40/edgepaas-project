---
# =============================================================================
# EdgePaaS Docker Installation & Host Preparation
# =============================================================================

# -----------------------------
# Ensure Required Packages Are Installed
# -----------------------------

- name: Ensure required packages are installed
  ansible.builtin.yum:
    name:
      - dnf
      - dnf-plugins-core
      - git
      - xfsprogs
      - yum-utils
    state: present
  become: true

# -----------------------------
# Remove Conflicting Docker Packages
# -----------------------------

- name: Remove any old conflicting Docker packages (EL7/CentOS etc)
  ansible.builtin.yum:
    name:
      - docker-ce
      - docker-ce-cli
      - docker-engine
      - docker.io
    state: absent
  become: true
  ignore_errors: true

# -----------------------------
# Clean Package Cache
# -----------------------------

- name: Clean dnf/yum cache
  ansible.builtin.command: dnf clean all
  become: true

# -----------------------------
# Install Docker
# -----------------------------

- name: Install Docker (AL2023 default package)
  ansible.builtin.yum:
    name: docker
    state: present
  become: true

# -----------------------------
# Configure Docker for Systemd Cgroup Driver
# -----------------------------

- name: Configure Docker daemon
  ansible.builtin.copy:
    dest: /etc/docker/daemon.json
    content: |
      {
        "exec-opts": ["native.cgroupdriver=systemd"]
      }
    owner: root
    group: root
    mode: '0644'
  become: true

# -----------------------------
# Enable and Start Docker Service
# -----------------------------

- name: Ensure Docker service is enabled and running
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true

# -----------------------------
# Add User to Docker Group
# -----------------------------

- name: Add current user to docker group
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes
  become: true

# -----------------------------
# Verify Docker Installation
# -----------------------------

- name: Verify Docker installatoin
  ansible.builtin.shell: docker info
  register: docker_info
  changed_when: false
  failed_when: "'Cgroup' not in docker_info.stdout"
  become: true
